<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portale Mappa Emergenze</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        html, body, #map {
            height: 100%; width: 100%; margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        #panel {
            position: absolute; top: 10px; right: 10px; z-index: 1000; background: white;
            padding: 15px; border-radius: 5px; box-shadow: 0 1px 5px rgba(0,0,0,0.65);
            width: 340px; max-height: 90%; overflow-y: auto;
        }
        #search-box { width: 100%; box-sizing: border-box; padding: 8px; font-size: 14px; margin-bottom: 5px; }
        #search-button {
            width: 100%; padding: 10px; background-color: #007bff; color: white; border: none;
            border-radius: 4px; cursor: pointer; margin-bottom: 15px; transition: background-color 0.2s;
        }
        #search-button:hover { background-color: #0056b3; }
        #search-button:disabled { background-color: #cccccc; cursor: not-allowed; }
        #results-content .result-item { 
            padding: 8px; border-bottom: 1px solid #eee; font-size: 14px; line-height: 1.5; cursor: pointer;
            transition: background-color 0.2s;
        }
        #results-content .result-item:hover { background-color: #f0f8ff; }
        h4 { margin-top: 0; }
        #status { text-align: center; padding: 10px; color: #555; font-style: italic; }

        .modal {
            display: none; position: fixed; z-index: 2000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; 
            background-color: rgba(0,0,0,0.5);
            justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: #fefefe; margin: auto; padding: 20px;
            border: 1px solid #888; border-radius: 8px; width: 80%; max-width: 500px;
            position: relative;
        }
        .modal-close { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .modal-close:hover, .modal-close:focus { color: black; text-decoration: none; cursor: pointer; }
        .modal-content h3 { margin-top: 0; }
        .modal-content p { line-height: 1.6; }

    </style>
</head>
<body>
    <div id="map"></div>
    <div id="panel">
        <h4>Cerca Emergenza</h4>
        <input type="text" id="search-box" placeholder="Caricamento dati..." disabled>
        <button id="search-button" onclick="searchLocation()" disabled>Cerca</button>
        <hr>
        <h4>Squadre Pi√π Vicine</h4>
        <div id="status"><p>Caricamento dati...</p></div>
        <div id="results-content"></div>
    </div>

    <div id="detail-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="hideModal()">&times;</span>
            <h3 id="modal-title"></h3>
            <p><strong>Comune:</strong> <span id="modal-comune"></span></p>
            <p><strong>Responsabile:</strong> <span id="modal-referente"></span></p>
            <p><strong>Contatto:</strong> <span id="modal-telefono"></span></p>
            <p><strong>Mezzo:</strong> <span id="modal-mezzo"></span></p>
            <p><strong>Targa:</strong> <span id="modal-targa"></span></p>
        </div>
    </div>

    <script>
        const SHEET_ID = '1mNeb2ObFeD72o-WfNEzM4f2JfWl9iguqN4KGytpFS_Y';
        const SHEET_NAME = 'Foglio1'; 
        const NUMBER_OF_RESULTS = 10;
        
        const COLUMN_NAMES = {
            name: 'associazione', municipality: 'comune', contactPerson: 'referente',
            contactInfo: 'telefono', vehicle: 'mezzo', plate: 'targa',
            sighting: 'avvistamento', lat: 'lat', lon: 'lon'
        };

        const map = L.map('map').setView([40.5, 15.8], 9);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        const firefightingIcon = L.icon({
            iconUrl: 'https://img.icons8.com/plasticine/100/fire-extinguisher.png',
            iconSize: [38, 38], iconAnchor: [19, 38], popupAnchor: [0, -38]
        });
        const sightingIcon = L.icon({
            iconUrl: 'https://img.icons8.com/plasticine/100/binoculars.png',
            iconSize: [38, 38], iconAnchor: [19, 38], popupAnchor: [0, -38]
        });
        const cdbIcon = L.icon({
            iconUrl: 'https://img.icons8.com/office/80/building.png', // Icona Edificio per CDB
            iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -32]
        });

        // Creiamo dei gruppi di livelli per poterli controllare
        const firefightingLayer = L.layerGroup().addTo(map);
        const sightingLayer = L.layerGroup().addTo(map);
        const cdbLayer = L.layerGroup().addTo(map);

        const organizations = [];
        let emergencyMarker;
        
        function updateResults(sortedOrgs) {
            const contentDiv = document.getElementById('results-content');
            contentDiv.innerHTML = '';
            sortedOrgs.slice(0, NUMBER_OF_RESULTS).forEach(org => {
                const item = document.createElement('div');
                item.className = 'result-item';
                item.innerHTML = `<b>${org.name}</b> (${org.municipality})<br>
                                  <i>Distanza: ${(org.distance / 1000).toFixed(2)} km</i>`;
                item.onclick = () => showModal(org);
                contentDiv.appendChild(item);
            });
        }
        
        const modal = document.getElementById('detail-modal');
        function showModal(org) {
            document.getElementById('modal-title').innerText = org.name;
            document.getElementById('modal-comune').innerText = org.municipality;
            document.getElementById('modal-referente').innerText = org.contactPerson;
            document.getElementById('modal-telefono').innerText = org.contactInfo;
            document.getElementById('modal-mezzo').innerText = org.vehicle;
            document.getElementById('modal-targa').innerText = org.plate;
            modal.style.display = "flex";
        }
        function hideModal() { modal.style.display = "none"; }
        window.onclick = function(event) { if (event.target == modal) hideModal(); }

        function processEmergency(latlng) {
            if (emergencyMarker) map.removeLayer(emergencyMarker);
            emergencyMarker = L.marker(latlng, { 
                icon: L.icon({ 
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41], iconAnchor: [12, 41]
                })
            }).addTo(map).bindPopup("<b>EMERGENZA</b>").openPopup();
            map.panTo(latlng);
            organizations.forEach(org => org.distance = latlng.distanceTo(org.latlng));
            const sortedOrgs = organizations.sort((a, b) => a.distance - b.distance);
            document.getElementById('status').style.display = 'none';
            updateResults(sortedOrgs);
        }

        async function searchLocation() {
            const query = document.getElementById('search-box').value;
            if (!query) return;
            const statusDiv = document.getElementById('status');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<p>Ricerca in corso...</p>';
            const coordRegex = /^[-\d.\s]+,[-\d.\s]+$/;
            if (coordRegex.test(query)) {
                const [lat, lon] = query.split(',').map(parseFloat);
                if (!isNaN(lat) && !isNaN(lon)) return processEmergency(L.latLng(lat, lon));
            }
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=it`);
                const data = await response.json();
                if (data && data.length > 0) processEmergency(L.latLng(data[0].lat, data[0].lon));
                else {
                    alert('Indirizzo non trovato.');
                    statusDiv.style.display = 'none';
                }
            } catch (error) {
                alert('Errore di rete.');
                statusDiv.style.display = 'none';
            }
        }
        
        const sheetUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}`;

        fetch(sheetUrl)
            .then(response => response.text())
            .then(text => {
                const json = JSON.parse(text.substring(47).slice(0, -2));
                const headers = json.table.cols.map(col => col.label.toLowerCase().trim());
                const rows = json.table.rows;
                
                const idx = {
                    name: headers.indexOf(COLUMN_NAMES.name), municipality: headers.indexOf(COLUMN_NAMES.municipality),
                    contactPerson: headers.indexOf(COLUMN_NAMES.contactPerson), contactInfo: headers.indexOf(COLUMN_NAMES.contactInfo),
                    vehicle: headers.indexOf(COLUMN_NAMES.vehicle), plate: headers.indexOf(COLUMN_NAMES.plate),
                    sighting: headers.indexOf(COLUMN_NAMES.sighting), lat: headers.indexOf(COLUMN_NAMES.lat),
                    lon: headers.indexOf(COLUMN_NAMES.lon)
                };

                if (idx.lat === -1 || idx.lon === -1) throw new Error(`Colonne '${COLUMN_NAMES.lat}' o '${COLUMN_NAMES.lon}' non trovate.`);

                rows.forEach(row => {
                    const lat = row.c[idx.lat] ? row.c[idx.lat].v : null;
                    const lon = row.c[idx.lon] ? row.c[idx.lon].v : null;

                    if (typeof lat === 'number' && typeof lon === 'number') {
                        const org = {
                            name: (idx.name > -1 && row.c[idx.name]) ? row.c[idx.name].v : 'N/D',
                            municipality: (idx.municipality > -1 && row.c[idx.municipality]) ? row.c[idx.municipality].v : 'N/D',
                            contactPerson: (idx.contactPerson > -1 && row.c[idx.contactPerson]) ? row.c[idx.contactPerson].v : 'N/D',
                            contactInfo: (idx.contactInfo > -1 && row.c[idx.contactInfo]) ? row.c[idx.contactInfo].v : 'N/D',
                            vehicle: (idx.vehicle > -1 && row.c[idx.vehicle]) ? row.c[idx.vehicle].v : 'N/D',
                            plate: (idx.plate > -1 && row.c[idx.plate]) ? row.c[idx.plate].v : 'N/D',
                            sighting: (idx.sighting > -1 && row.c[idx.sighting]) ? row.c[idx.sighting].v : '',
                            latlng: L.latLng(lat, lon)
                        };
                        organizations.push(org);
                        
                        let markerIcon;
                        let targetLayer;

                        if (org.name && org.name.toUpperCase() === 'CDB') {
                            markerIcon = cdbIcon;
                            targetLayer = cdbLayer;
                        } else if (org.sighting && org.sighting.toLowerCase() === 'si') {
                            markerIcon = sightingIcon;
                            targetLayer = sightingLayer;
                        } else {
                            markerIcon = firefightingIcon;
                            targetLayer = firefightingLayer;
                        }
                        
                        const popupContent = `<b>${org.name}</b><br>Comune: ${org.municipality}<br>Contatto: ${org.contactInfo}`;
                        L.marker(org.latlng, {icon: markerIcon}).addTo(targetLayer).bindPopup(popupContent);
                    }
                });

                // Aggiungiamo il controllo dei livelli alla mappa
                const overlayMaps = {
                    "Squadre Operative": firefightingLayer,
                    "Squadre Avvistamento": sightingLayer,
                    "Consorzi di Bonifica": cdbLayer
                };
                L.control.layers(null, overlayMaps, { collapsed: false }).addTo(map);


                console.log(`${organizations.length} organizzazioni caricate.`);
                document.getElementById('search-box').disabled = false;
                document.getElementById('search-button').disabled = false;
                document.getElementById('search-box').placeholder = "Indirizzo o Lat,Lon";
                document.getElementById('status').innerHTML = '<p style="font-size: 14px;">Pronto.</p>';
                map.on('click', e => processEmergency(e.latlng));
            })
            .catch(error => {
                console.error('Errore nel caricamento dei dati:', error);
                document.getElementById('status').innerHTML = `<p style="color:red;">Errore caricamento dati. Controlla la console per i dettagli.</p>`;
            });

        document.getElementById('search-box').addEventListener('keyup', e => {
            if (e.key === 'Enter') document.getElementById('search-button').click();
        });
    </script>
</body>
</html>
