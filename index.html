<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portale SOUP Basilicata</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        html, body {
            height: 100%; width: 100%; margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden; background-color: #f0f0f0;
        }

        /* BANNER */
        #app-header {
            position: absolute; top: 0; left: 0; width: 100%; z-index: 1001;
            background: linear-gradient(180deg, rgba(255,255,255,1) 0%, rgba(248,249,250,1) 100%);
            color: #212529; padding: 15px 30px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15); box-sizing: border-box;
            border-bottom: 1px solid #dee2e6;
        }
        .header-logo img { height: 60px; }
        .header-title { text-align: center; flex-grow: 1; margin: 0 20px; }
        .header-title h1 { font-size: 2em; margin: 0; font-weight: 600; }
        .header-title p { font-size: 1em; margin: 0; color: #6c757d; }
        .header-nav { display: flex; flex-wrap: nowrap; }
        .header-nav .nav-button {
            padding: 12px 18px; margin-left: 10px; background-color: #f8f9fa; color: #343a40;
            text-decoration: none; border: 1px solid #ced4da; border-radius: 5px; font-size: 14px;
            cursor: pointer; transition: all 0.2s; font-weight: 500; white-space: nowrap;
        }
        .header-nav .nav-button:hover { background-color: #e2e6ea; border-color: #adb5bd; }
        .nav-button.reset-button { background-color: #ffc107; border-color: #ffc107; font-weight: bold; }

        #map { height: 100%; width: 100%; }
        .leaflet-top { top: 105px; }
        
        /* PANNELLI STILE DASHBOARD */
        .dashboard-panel {
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(200, 200, 200, 0.5);
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        #panel {
            position: absolute; top: 105px; right: 15px; z-index: 1000;
            padding: 20px; width: 420px; max-height: calc(100% - 120px); overflow-y: auto;
        }
        #stats-box {
            position: absolute; bottom: 15px; left: 15px; z-index: 1000;
            padding: 15px 20px; font-size: 16px;
        }
        #stats-box h4 { margin: 0 0 10px 0; border-bottom: 1px solid #ccc; padding-bottom: 8px; font-size: 1.1em;}
        #stats-box p { margin: 6px 0; }
        .leaflet-control-layers { border: none !important; font-size: 14px; }
        .leaflet-control-layers-list { padding: 10px; }

        /* RISULTATI e STATI */
        #results-content .result-item { padding: 10px; border: 2px solid transparent; border-bottom: 1px solid #eee; font-size: 15px; line-height: 1.5; cursor: pointer; }
        #results-content .result-item:hover { background-color: #f0f8ff; }
        .recommended { animation: flashing-border 1.5s infinite; }
        @keyframes flashing-border { 0%, 100% { border-color: #28a745; } 50% { border-color: transparent; } }
        .marker-unavailable { filter: grayscale(100%) opacity: 0.5; }
        
        /* MODALE */
        .modal-content { max-width: 700px; padding: 30px; }
        
        /* Altri stili invariati */
        .modal{display:none;position:fixed;z-index:2000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);justify-content:center;align-items:center}.modal-content{background-color:#fefefe;margin:auto;border-radius:8px;width:90%;position:relative}.modal-close{color:#aaa;float:right;font-size:28px;font-weight:700;cursor:pointer}#modal-actions button{width:100%;padding:12px;font-size:16px;margin-top:15px;border-radius:4px;border:none;color:#fff;cursor:pointer}#assign-button{background-color:#28a745}#release-button{background-color:#dc3545}
    </style>
</head>
<body>

    <header id="app-header">
        <div class="header-logo"><img src="logo.png" alt="Logo"></div>
        <div class="header-title">
            <h1>SALA OPERATIVA UNIFICATA REGIONE BASILICATA</h1>
            <p>Credits: Protezione Civile Basilicata - AM</p>
        </div>
        <nav class="header-nav">
            <a href="https://www.formazionesicurezza.org/protezionecivile/acqua/" target="_blank" class="nav-button">Risorse Idriche</a>
            <a href="https://macnil.gtfleet.net/" target="_blank" class="nav-button">GPS ODV</a>
            <a href="https://gtalarm.net/" target="_blank" class="nav-button">GPS CDB</a>
            <button class="nav-button reset-button" onclick="resetState()">Reset Stato</button>
        </nav>
    </header>

    <div id="map"></div>

    <div id="panel" class="dashboard-panel">
        <h4>Cerca Emergenza</h4>
        <input type="text" id="search-box" placeholder="Caricamento dati..." disabled>
        <button id="search-button" onclick="searchLocation()" disabled>Cerca</button>
        <hr>
        <h4>Squadre Pi√π Vicine</h4>
        <div id="status"><p>Caricamento dati...</p></div>
        <div id="results-content"></div>
    </div>
    
    <div id="stats-box" class="dashboard-panel">
        <h4>Stato Risorse</h4>
        <p><strong>Associazioni:</strong> <span id="odv-stats">0 / 0</span> (Imp. / Tot.)</p>
        <p><strong>CDB:</strong> <span id="cdb-stats">0 / 0</span> (Imp. / Tot.)</p>
        <p><strong>Eventi Attivi:</strong> <span id="events-stats">0</span></p>
    </div>

    <div id="detail-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="hideModal()">&times;</span>
            <h3 id="modal-title"></h3>
            <p><strong>Comune:</strong> <span id="modal-comune"></span></p>
            <p><strong>Responsabile:</strong> <span id="modal-referente"></span></p>
            <p><strong>Contatto:</strong> <span id="modal-telefono"></span></p>
            <hr>
            <p><strong>Stato:</strong> <span id="modal-stato"></span></p>
            <div id="modal-actions"></div>
        </div>
    </div>

    <script>
        const SHEET_ID = '1mNeb2ObFeD72o-WfNEzM4f2JfWl9iguqN4KGytpFS_Y';
        const SHEET_NAME = 'Foglio1'; 
        const NUMBER_OF_RESULTS = 10;
        
        const COLUMN_NAMES = { name: 'associazione', municipality: 'comune', contactPerson: 'referente', contactInfo: 'telefono', sighting: 'avvistamento', lat: 'lat', lon: 'lon' };

        const map = L.map('map', { zoomControl: false });
        L.control.zoom({ position: 'topleft' }).addTo(map);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors' }).addTo(map);
        
        const firefightingIcon = L.icon({ iconUrl: 'https://img.icons8.com/plasticine/100/fire-extinguisher.png', iconSize: [38, 38], iconAnchor: [19, 38] });
        const sightingIcon = L.icon({ iconUrl: 'https://img.icons8.com/plasticine/100/binoculars.png', iconSize: [38, 38], iconAnchor: [19, 38] });
        const cdbIcon = L.icon({ iconUrl: 'https://img.icons8.com/office/80/building.png', iconSize: [32, 32], iconAnchor: [16, 32] });
        const flameIcon = L.icon({ iconUrl: 'https://img.icons8.com/fluency/96/fire-element--v1.png', iconSize: [42, 42], iconAnchor: [21, 42] });

        const layerGroups = {
            firefighting: L.layerGroup().addTo(map), sighting: L.layerGroup().addTo(map),
            cdb: L.layerGroup().addTo(map), region: L.layerGroup().addTo(map),
            municipality: L.layerGroup(),
            events: L.layerGroup().addTo(map)
        };

        const organizations = [];
        let activeEvents = [];
        let currentEventForAssignment = null;
        let regionBounds = null;
        let tempEventMarker = null;
        
        const modal = document.getElementById('detail-modal');
        
        function updateCounters() { /* ... codice ... */ }
        function updateResults(sortedOrgs, recommendedName) { /* ... codice ... */ }
        function showModal(org) { /* ... codice ... */ }
        function hideModal() { modal.style.display = "none"; }
        window.onclick = function(event) { if (event.target == modal) hideModal(); }
        function assignTeam(org) { /* ... codice ... */ }
        function releaseTeam(org) { /* ... codice ... */ }
        function confirmEvent(lat, lon) { /* ... codice ... */ }
        function cancelEvent() { if (tempEventMarker) { map.removeLayer(tempEventMarker); tempEventMarker = null; } }
        async function createConfirmationPopup(latlng) { /* ... codice ... */ }
        function resetState() { /* ... codice ... */ }
        async function searchLocation() { /* ... codice ... */ }
        
        // --- INCOLLA QUI LE FUNZIONI COMPLETE ---
        function updateCounters(){const t=organizations.filter(n=>"CDB"!==n.type).length,e=organizations.filter(n=>"CDB"!==n.type&&n.isAssigned).length,o=organizations.filter(n=>"CDB"===n.type).length,n=organizations.filter(n=>"CDB"===n.type&&n.isAssigned).length;document.getElementById("odv-stats").innerText=`${e} / ${t}`,document.getElementById("cdb-stats").innerText=`${n} / ${o}`,document.getElementById("events-stats").innerText=activeEvents.length}
        function updateResults(t,e){const n=document.getElementById("results-content");n.innerHTML="",t.slice(0,NUMBER_OF_RESULTS).forEach(t=>{const o=document.createElement("div");o.className="result-item",e===t.name&&o.classList.add("recommended"),o.innerHTML=`<b>${t.name}</b> (${t.municipality})<br><i>Distanza: ${(t.distance/1e3).toFixed(2)} km</i>`,o.onclick=()=>showModal(t),n.appendChild(o)})}
        function showModal(t){document.getElementById("modal-title").innerText=t.name,document.getElementById("modal-comune").innerText=t.municipality,document.getElementById("modal-referente").innerText=t.contactPerson,document.getElementById("modal-telefono").innerText=t.contactInfo;const e=document.getElementById("modal-stato"),n=document.getElementById("modal-actions");if(n.innerHTML="",t.isAssigned){const o=activeEvents.find(e=>e.assignedTeam&&e.assignedTeam.name===t.name);e.innerHTML=`<span style="color:red; font-weight:bold;">IMPEGNATA</span> (Evento ID: ${o?o.sigerId:"..."})`;const i=document.createElement("button");i.id="release-button",i.innerText="Sgancia Squadra",i.onclick=()=>releaseTeam(t),n.appendChild(i)}else{e.innerHTML=`<span style="color:green; font-weight:bold;">LIBERA</span>`;const o=document.createElement("button");o.id="assign-button",o.innerText="Assegna a Evento Corrente",o.onclick=()=>assignTeam(t),currentEventForAssignment&&!currentEventForAssignment.assignedTeam||(o.disabled=!0,o.innerText="Nessun evento attivo per assegnazione"),n.appendChild(o)}modal.style.display="flex"}
        function assignTeam(t){const e=prompt("Inserisci l'ID SIGER di riferimento (facoltativo):","");null!==e&&(t.isAssigned=!0,currentEventForAssignment.assignedTeam=t,currentEventForAssignment.sigerId=e||"N/A",t.marker.getElement().classList.add("marker-unavailable"),currentEventForAssignment.marker.bindPopup(`<b>Evento ID: ${e}</b><br>Squadra: ${t.name}`).openPopup(),hideModal(),updateCounters(),processEmergency(currentEventForAssignment.latlng,!1))}
        function releaseTeam(t){const e=activeEvents.find(e=>e.assignedTeam&&e.assignedTeam.name===t.name);e&&(e.assignedTeam=null),t.isAssigned=!1,t.marker.getElement().classList.remove("marker-unavailable"),hideModal(),updateCounters()}
        async function createConfirmationPopup(t){cancelEvent();const e=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${t.lat}&lon=${t.lng}`),n=await e.json();let o="Posizione Sconosciuta";n&&n.display_name&&(o=n.display_name.split(",").slice(0,3).join(","));const i=`<div style="text-align:center;"><b>Creare evento qui?</b><br><small>${o}</small><br><br><button onclick="confirmEvent(${t.lat}, ${t.lng})">Conferma</button> <button onclick="cancelEvent()">Annulla</button></div>`;tempEventMarker=L.marker(t,{icon:flameIcon}).addTo(map).bindPopup(i).openPopup()}
        function confirmEvent(t,e){cancelEvent(),processEmergency(L.latLng(t,e))}
        async function processEmergency(t,e=!0){if(e){currentEventForAssignment={id:Date.now(),sigerId:null,marker:null,assignedTeam:null,latlng:t},activeEvents.push(currentEventForAssignment);const n=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${t.lat}&lon=${t.lng}`),o=await n.json();let i="Posizione Sconosciuta";o&&o.display_name&&(i=o.display_name.split(",").slice(0,3).join(",")),currentEventForAssignment.marker=L.marker(t,{icon:flameIcon}).addTo(layerGroups.events).bindPopup(`<b>Nuovo Evento</b><br>${i}`).openPopup()}map.panTo(t);const n=organizations.filter(t=>!t.isAssigned);n.forEach(e=>e.distance=t.distanceTo(e.latlng));const o=n.sort((t,e)=>t.distance-e.distance);let i=null;const s=o.find(t=>"CDB"===t.type);s?i=s.name:o.length>0&&(i=o[0].name),document.getElementById("status").style.display="none",updateResults(o,i),updateCounters()}
        function resetState(){organizations.forEach(t=>{t.isAssigned=!1,t.marker.getElement()&&t.marker.getElement().classList.remove("marker-unavailable")}),layerGroups.events.clearLayers(),activeEvents=[],currentEventForAssignment=null,document.getElementById("results-content").innerHTML="",document.getElementById("status").innerHTML='<p style="font-size: 14px;">Pronto.</p>',document.getElementById("status").style.display="block",updateCounters()}
        async function searchLocation(){const t=document.getElementById("search-box").value;if(t)try{const e=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(t)}&countrycodes=it`),n=await e.json();n&&n.length>0?createConfirmationPopup(L.latLng(n[0].lat,n[0].lon)):alert("Indirizzo non trovato.")}catch(t){alert("Errore di rete.")}}

        // --- CARICAMENTO DATI ---
        Promise.all([
            fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}`).then(res => res.text()),
            fetch('https://raw.githubusercontent.com/openpolis/geojson-italy/master/geojson/limits_IT_regions.geojson').then(res => res.json()),
            fetch('https://raw.githubusercontent.com/openpolis/geojson-italy/master/geojson/limits_IT_municipalities.geojson').then(res => res.json())
        ]).then(([sheetText, regionData, municipalityData]) => {
            const json = JSON.parse(sheetText.substring(47).slice(0, -2));
            const headers = json.table.cols.map(col => col.label.toLowerCase().trim());
            const rows = json.table.rows;
            const idx = { name: headers.indexOf(COLUMN_NAMES.name), municipality: headers.indexOf(COLUMN_NAMES.municipality), contactPerson: headers.indexOf(COLUMN_NAMES.contactPerson), contactInfo: headers.indexOf(COLUMN_NAMES.contactInfo), sighting: headers.indexOf(COLUMN_NAMES.sighting), lat: headers.indexOf(COLUMN_NAMES.lat), lon: headers.indexOf(COLUMN_NAMES.lon) };
            rows.forEach(row => {
                const lat = row.c[idx.lat] ? row.c[idx.lat].v : null;
                const lon = row.c[idx.lon] ? row.c[idx.lon].v : null;
                if (typeof lat === 'number' && typeof lon === 'number') {
                    const orgName = (idx.name > -1 && row.c[idx.name]) ? row.c[idx.name].v : 'N/D';
                    const org = {
                        name: orgName, municipality: (idx.municipality > -1 && row.c[idx.municipality]) ? row.c[idx.municipality].v : 'N/D',
                        contactPerson: (idx.contactPerson > -1 && row.c[idx.contactPerson]) ? row.c[idx.contactPerson].v : 'N/D',
                        contactInfo: (idx.contactInfo > -1 && row.c[idx.contactInfo]) ? row.c[idx.contactInfo].v : 'N/D',
                        sighting: (idx.sighting > -1 && row.c[idx.sighting]) ? row.c[idx.sighting].v : '',
                        latlng: L.latLng(lat, lon), isAssigned: false, type: orgName.toUpperCase() === 'CDB' ? 'CDB' : 'ODV'
                    };
                    let markerIcon, targetLayer;
                    if (org.type === 'CDB') { markerIcon = cdbIcon; targetLayer = layerGroups.cdb; } 
                    else if (org.sighting.toLowerCase() === 'si') { markerIcon = sightingIcon; targetLayer = layerGroups.sighting; }
                    else { markerIcon = firefightingIcon; targetLayer = layerGroups.firefighting; }
                    org.marker = L.marker(org.latlng, {icon: markerIcon}).addTo(targetLayer).on('click', () => showModal(org));
                    organizations.push(org);
                }
            });
            
            const regionGeoJsonLayer = L.geoJson(regionData, { style: {"color": "#0d6efd", "weight": 2.5, "opacity": 0.7, "fillOpacity": 0.1}, filter: (f) => f.properties.reg_istat_code_num === 17 }).addTo(layerGroups.region);
            regionBounds = regionGeoJsonLayer.getBounds();
            map.fitBounds(regionBounds);
            
            L.geoJson(municipalityData, { style: {"color": "#6c757d", "weight": 1, "opacity": 0.5, "fillOpacity": 0.05}, filter: (f) => f.properties.reg_istat_code_num === 17 }).addTo(layerGroups.municipality);
            
            const layerControl = L.control.layers(null, {
                "Confine Regionale": layerGroups.region, "Confini Comunali": layerGroups.municipality,
                "Squadre Operative": layerGroups.firefighting, "Squadre Avvistamento": layerGroups.sighting,
                "Consorzi di Bonifica": layerGroups.cdb, "Eventi": layerGroups.events
            }, { position: 'topleft', collapsed: false }).addTo(map);
            layerControl.getContainer().classList.add('dashboard-panel');

            updateCounters();
            document.getElementById('search-box').disabled = false;
            document.getElementById('search-button').disabled = false;
            document.getElementById('search-box').placeholder = "Indirizzo o Lat,Lon";
            document.getElementById('status').innerHTML = '<p style="font-size: 14px;">Pronto.</p>';
            
            map.on('click', e => {
                if (regionBounds && !regionBounds.contains(e.latlng)) { return; }
                createConfirmationPopup(e.latlng);
            });
        }).catch(error => {
            console.error('Errore critico durante il caricamento:', error);
            document.getElementById('status').innerHTML = `<p style="color:red;">Errore caricamento dati. Controlla la console.</p>`;
        });
        
        document.getElementById('search-box').addEventListener('keyup', e => { if (e.key === 'Enter') document.getElementById('search-button').click(); });
    </script>
</body>
</html>
