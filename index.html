<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portale SOUP Basilicata</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        html, body {
            height: 100%; width: 100%; margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
        }

        /* Stili Banner */
        #app-header {
            position: absolute; top: 0; left: 0; width: 100%; z-index: 1001;
            background-color: #ffffff; color: #333; padding: 10px 20px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); box-sizing: border-box;
        }
        .header-logo img { height: 50px; }
        .header-title { text-align: center; flex-grow: 1; margin: 0 20px; }
        .header-title h1 { font-size: 1.5em; margin: 0; }
        .header-title p { font-size: 0.8em; margin: 0; color: #666; }
        .header-nav .nav-button {
            padding: 10px 15px; margin-left: 5px; background-color: #f0f0f0; color: #333;
            text-decoration: none; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;
            cursor: pointer; transition: background-color 0.2s; white-space: nowrap;
        }
        .header-nav .nav-button:hover { background-color: #e0e0e0; }
        .nav-button.reset-button { background-color: #ffc107; font-weight: bold; }
        .nav-button.reset-button:hover { background-color: #e0a800; }


        #map { height: 100%; width: 100%; }
        .leaflet-top { top: 80px; }
        #panel {
            position: absolute; top: 80px; right: 10px; z-index: 1000; background: white;
            padding: 15px; border-radius: 5px; box-shadow: 0 1px 5px rgba(0,0,0,0.65);
            width: 380px; max-height: calc(100% - 90px); overflow-y: auto;
        }
        
        /* Stili Risultati e Stato */
        #results-content .result-item { 
            padding: 8px; border: 2px solid transparent; border-bottom: 1px solid #eee; 
            font-size: 14px; line-height: 1.5; cursor: pointer; transition: all 0.2s;
        }
        #results-content .result-item:hover { background-color: #f0f8ff; }
        .recommended { animation: flashing-border 2s infinite; }
        @keyframes flashing-border { 0% { border-color: #28a745; } 50% { border-color: transparent; } 100% { border-color: #28a745; } }
        .assigned { border: 2px solid #28a745; background-color: #e8f5e9; }
        .marker-unavailable { filter: grayscale(100%) opacity(0.5); }
        
        #search-box { width: 100%; box-sizing: border-box; padding: 8px; font-size: 14px; margin-bottom: 5px; }
        #search-button { width: 100%; padding: 10px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 15px; }
        h4 { margin-top: 0; }
        #status { text-align: center; padding: 10px; color: #555; font-style: italic; }
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 25px; border: 1px solid #888; border-radius: 8px; width: 90%; max-width: 600px; position: relative; }
        .modal-close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <header id="app-header">
        <div class="header-logo">
            <img src="logo.png" alt="Logo Protezione Civile Basilicata">
        </div>
        <div class="header-title">
            <h1>SALA OPERATIVA UNIFICATA REGIONE BASILICATA</h1>
            <p>Credits: Protezione Civile Basilicata - AM</p>
        </div>
        <nav class="header-nav">
            <a href="https://www.formazionesicurezza.org/protezionecivile/acqua/" target="_blank" rel="noopener noreferrer" class="nav-button">Risorse Idriche</a>
            <a href="https://macnil.gtfleet.net/" target="_blank" rel="noopener noreferrer" class="nav-button">GPS ODV</a>
            <a href="https://gtalarm.net/" target="_blank" rel="noopener noreferrer" class="nav-button">GPS CDB</a>
            <a href="https://traccar.arka.tech/" target="_blank" rel="noopener noreferrer" class="nav-button">GPS ELICOTTERO</a>
            <a href="https://www.flightradar24.com/" target="_blank" rel="noopener noreferrer" class="nav-button">FLIGHT RADAR</a>
            <a href="http://cf.protezionecivilebasilicata.it/basi/index.asp" target="_blank" rel="noopener noreferrer" class="nav-button">RUBRICA PC</a>
            <button class="nav-button reset-button" onclick="resetState()">Reset Stato</button>
        </nav>
    </header>

    <div id="map"></div>
    <div id="panel">
        <h4>Cerca Emergenza</h4>
        <input type="text" id="search-box" placeholder="Caricamento dati..." disabled>
        <button id="search-button" onclick="searchLocation()" disabled>Cerca</button>
        <hr>
        <h4>Squadre Più Vicine</h4>
        <div id="status"><p>Caricamento dati...</p></div>
        <div id="results-content"></div>
    </div>

    <div id="detail-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="hideModal()">&times;</span>
            <h3 id="modal-title"></h3>
            <p><strong>Comune:</strong> <span id="modal-comune"></span></p>
            <p><strong>Responsabile:</strong> <span id="modal-referente"></span></p>
            <p><strong>Contatto:</strong> <span id="modal-telefono"></span></p>
            <p><strong>Mezzo:</strong> <span id="modal-mezzo"></span></p>
            <p><strong>Targa:</strong> <span id="modal-targa"></span></p>
        </div>
    </div>

    <script>
        const SHEET_ID = '1mNeb2ObFeD72o-WfNEzM4f2JfWl9iguqN4KGytpFS_Y';
        const SHEET_NAME = 'Foglio1'; 
        const NUMBER_OF_RESULTS = 10;
        
        const COLUMN_NAMES = {
            name: 'associazione', municipality: 'comune', contactPerson: 'referente',
            contactInfo: 'telefono', vehicle: 'mezzo', plate: 'targa',
            sighting: 'avvistamento', lat: 'lat', lon: 'lon'
        };

        const map = L.map('map', { zoomControl: false });
        L.control.zoom({ position: 'topleft' }).addTo(map);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        const firefightingIcon = L.icon({ iconUrl: 'https://img.icons8.com/plasticine/100/fire-extinguisher.png', iconSize: [38, 38], iconAnchor: [19, 38] });
        const sightingIcon = L.icon({ iconUrl: 'https://img.icons8.com/plasticine/100/binoculars.png', iconSize: [38, 38], iconAnchor: [19, 38] });
        const cdbIcon = L.icon({ iconUrl: 'https://img.icons8.com/office/80/building.png', iconSize: [32, 32], iconAnchor: [16, 32] });
        const flameIcon = L.icon({ iconUrl: 'https://img.icons8.com/fluency/96/fire-element--v1.png', iconSize: [42, 42], iconAnchor: [21, 42] });

        const layerGroups = {
            firefighting: L.layerGroup().addTo(map), sighting: L.layerGroup().addTo(map),
            cdb: L.layerGroup().addTo(map), region: L.layerGroup().addTo(map),
            municipality: L.layerGroup().addTo(map), events: L.layerGroup().addTo(map)
        };

        const organizations = [];
        let activeEvents = [];
        let currentEvent = null;
        let regionBounds = null; // Variabile per memorizzare i confini
        
        const modal = document.getElementById('detail-modal');
        function showModal(org) { /* ... (codice invariato) ... */ }
        function hideModal() { modal.style.display = "none"; }
        window.onclick = function(event) { if (event.target == modal) hideModal(); }

        async function assignTeam(org, element) {
            if (!currentEvent || currentEvent.assignedTeam) {
                showModal(org);
                return;
            }

            const eventId = prompt("Inserisci l'ID SIGER per abbinare la squadra all'evento:", "");
            if (!eventId) return; // L'utente ha annullato

            org.assigned = true;
            currentEvent.id = eventId;
            currentEvent.assignedTeam = org;
            
            // Aggiorna il popup dell'evento con l'ID
            const latlng = currentEvent.marker.getLatLng();
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latlng.lat}&lon=${latlng.lng}`);
            const data = await response.json();
            let popupText = `<b>Evento ID: ${eventId}</b>`;
            if (data && data.address) {
                const municipality = data.address.municipality || data.address.town || data.address.village || data.address.city;
                if (municipality) popupText += `<br>Comune: ${municipality}`;
            }
            currentEvent.marker.bindPopup(popupText).openPopup();
            
            document.querySelectorAll('.result-item').forEach(el => el.classList.remove('assigned', 'recommended'));
            element.classList.add('assigned');
            org.marker.getElement().classList.add('marker-unavailable');
            showModal(org);
        }
        
        function updateResults(sortedOrgs, recommendedName) {
            const contentDiv = document.getElementById('results-content');
            contentDiv.innerHTML = '';
            sortedOrgs.slice(0, NUMBER_OF_RESULTS).forEach(org => {
                const item = document.createElement('div');
                item.className = 'result-item';
                if (org.name === recommendedName && (!currentEvent || !currentEvent.assignedTeam)) {
                    item.classList.add('recommended');
                }
                item.innerHTML = `<b>${org.name}</b> (${org.municipality})<br>
                                  <i>Distanza: ${(org.distance / 1000).toFixed(2)} km</i>`;
                item.onclick = () => assignTeam(org, item);
                contentDiv.appendChild(item);
            });
        }

        function processEmergency(latlng) {
            if (currentEvent && !currentEvent.assignedTeam) {
                // Rimuove un evento precedente se non è stato finalizzato
                layerGroups.events.removeLayer(currentEvent.marker);
            }

            const popupText = `<b>Nuovo Evento</b><br><i>Assegna una squadra per confermare</i>`;
            const eventMarker = L.marker(latlng, { icon: flameIcon }).addTo(layerGroups.events).bindPopup(popupText).openPopup();
            currentEvent = { marker: eventMarker, assignedTeam: null };
            
            map.panTo(latlng);
            
            const availableOrgs = organizations.filter(org => !org.assigned);
            availableOrgs.forEach(org => org.distance = latlng.distanceTo(org.latlng));
            const sortedOrgs = availableOrgs.sort((a, b) => a.distance - b.distance);
            
            let recommendedName = null;
            const recommendedCDB = sortedOrgs.find(org => org.name.toUpperCase() === 'CDB');
            if (recommendedCDB) {
                recommendedName = recommendedCDB.name;
            } else if (sortedOrgs.length > 0) {
                recommendedName = sortedOrgs[0].name;
            }

            document.getElementById('status').style.display = 'none';
            updateResults(sortedOrgs, recommendedName);
        }
        
        function resetState() {
            organizations.forEach(org => {
                org.assigned = false;
                if (org.marker.getElement()) {
                    org.marker.getElement().classList.remove('marker-unavailable');
                }
            });
            layerGroups.events.clearLayers();
            activeEvents = [];
            currentEvent = null;
            document.getElementById('results-content').innerHTML = '';
            document.getElementById('status').innerHTML = '<p style="font-size: 14px;">Pronto.</p>';
            document.getElementById('status').style.display = 'block';
            console.log("Stato resettato.");
        }

        async function searchLocation() {
            // ... (logica di ricerca invariata)
        }

        // --- Inizializzazione e Caricamento Dati ---
        Promise.all([
            fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}`).then(res => res.text()),
            fetch('https://raw.githubusercontent.com/openpolis/geojson-italy/master/geojson/limits_IT_regions.geojson').then(res => res.json()),
            fetch('https://raw.githubusercontent.com/openpolis/geojson-italy/master/geojson/limits_IT_municipalities.geojson').then(res => res.json())
        ]).then(([sheetText, regionData, municipalityData]) => {
            const json = JSON.parse(sheetText.substring(47).slice(0, -2));
            const headers = json.table.cols.map(col => col.label.toLowerCase().trim());
            const rows = json.table.rows;
            const idx = {
                name: headers.indexOf(COLUMN_NAMES.name), municipality: headers.indexOf(COLUMN_NAMES.municipality),
                contactPerson: headers.indexOf(COLUMN_NAMES.contactPerson), contactInfo: headers.indexOf(COLUMN_NAMES.contactInfo),
                vehicle: headers.indexOf(COLUMN_NAMES.vehicle), plate: headers.indexOf(COLUMN_NAMES.plate),
                sighting: headers.indexOf(COLUMN_NAMES.sighting), lat: headers.indexOf(COLUMN_NAMES.lat), lon: headers.indexOf(COLUMN_NAMES.lon)
            };
            if (idx.lat === -1 || idx.lon === -1) throw new Error(`Colonne '${COLUMN_NAMES.lat}' o '${COLUMN_NAMES.lon}' non trovate.`);
            rows.forEach(row => {
                const lat = row.c[idx.lat] ? row.c[idx.lat].v : null;
                const lon = row.c[idx.lon] ? row.c[idx.lon].v : null;
                if (typeof lat === 'number' && typeof lon === 'number') {
                    const org = {
                        name: (idx.name > -1 && row.c[idx.name]) ? row.c[idx.name].v : 'N/D',
                        municipality: (idx.municipality > -1 && row.c[idx.municipality]) ? row.c[idx.municipality].v : 'N/D',
                        contactPerson: (idx.contactPerson > -1 && row.c[idx.contactPerson]) ? row.c[idx.contactPerson].v : 'N/D',
                        contactInfo: (idx.contactInfo > -1 && row.c[idx.contactInfo]) ? row.c[idx.contactInfo].v : 'N/D',
                        vehicle: (idx.vehicle > -1 && row.c[idx.vehicle]) ? row.c[idx.vehicle].v : 'N/D',
                        plate: (idx.plate > -1 && row.c[idx.plate]) ? row.c[idx.plate].v : 'N/D',
                        sighting: (idx.sighting > -1 && row.c[idx.sighting]) ? row.c[idx.sighting].v : '',
                        latlng: L.latLng(lat, lon),
                        assigned: false
                    };
                    let markerIcon, targetLayer;
                    if (org.name.toUpperCase() === 'CDB') {
                        markerIcon = cdbIcon; targetLayer = layerGroups.cdb;
                    } else if (org.sighting.toLowerCase() === 'si') {
                        markerIcon = sightingIcon; targetLayer = layerGroups.sighting;
                    } else {
                        markerIcon = firefightingIcon; targetLayer = layerGroups.firefighting;
                    }
                    const popupContent = `<b>${org.name}</b><br>Comune: ${org.municipality}<br>Contatto: ${org.contactInfo}`;
                    org.marker = L.marker(org.latlng, {icon: markerIcon}).addTo(targetLayer).bindPopup(popupContent);
                    organizations.push(org);
                }
            });

            const regionGeoJsonLayer = L.geoJson(regionData, { style: {"color": "#0d6efd", "weight": 3, "opacity": 0.8, "fillOpacity": 0.05}, filter: (f) => f.properties.reg_istat_code_num === 17 }).addTo(layerGroups.region);
            regionBounds = regionGeoJsonLayer.getBounds(); // Salva i confini
            map.fitBounds(regionBounds);

            L.geoJson(municipalityData, { style: {"color": "#6c757d", "weight": 1, "opacity": 0.6, "fillOpacity": 0.05}, filter: (f) => f.properties.reg_istat_code_num === 17 }).addTo(layerGroups.municipality);
            
            L.control.layers(null, {
                "Confine Regionale": layerGroups.region, "Confini Comunali": layerGroups.municipality,
                "Squadre Operative": layerGroups.firefighting, "Squadre Avvistamento": layerGroups.sighting,
                "Consorzi di Bonifica": layerGroups.cdb, "Eventi": layerGroups.events
            }, { collapsed: false }).addTo(map);

            console.log(`${organizations.length} organizzazioni caricate.`);
            document.getElementById('search-box').disabled = false;
            document.getElementById('search-button').disabled = false;
            document.getElementById('search-box').placeholder = "Indirizzo o Lat,Lon";
            document.getElementById('status').innerHTML = '<p style="font-size: 14px;">Pronto.</p>';
            
            // Abilita il click sulla mappa solo ora, con il controllo dei confini
            map.on('click', e => {
                if (regionBounds && !regionBounds.contains(e.latlng)) {
                    alert("Per favore, clicca all'interno dei confini della Basilicata.");
                    return;
                }
                processEmergency(e.latlng);
            });

        }).catch(error => {
            console.error('Errore critico durante il caricamento:', error);
            document.getElementById('status').innerHTML = `<p style="color:red;">Errore caricamento dati. Controlla la console.</p>`;
        });
        
        // --- Codice Invariato per UI ---
        function showModal(org) { document.getElementById('modal-title').innerText = org.name; document.getElementById('modal-comune').innerText = org.municipality; document.getElementById('modal-referente').innerText = org.contactPerson; document.getElementById('modal-telefono').innerText = org.contactInfo; document.getElementById('modal-mezzo').innerText = org.vehicle; document.getElementById('modal-targa').innerText = org.plate; modal.style.display = "flex"; }
        async function searchLocation() { const query = document.getElementById('search-box').value; if (!query) return; const statusDiv = document.getElementById('status'); statusDiv.style.display = 'block'; statusDiv.innerHTML = '<p>Ricerca in corso...</p>'; const coordRegex = /^[-\d.\s]+,[-\d.\s]+$/; if (coordRegex.test(query)) { const [lat, lon] = query.split(',').map(parseFloat); if (!isNaN(lat) && !isNaN(lon)) return processEmergency(L.latLng(lat, lon)); } try { const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=it`); const data = await response.json(); if (data && data.length > 0) processEmergency(L.latLng(data[0].lat, data[0].lon)); else { alert('Indirizzo non trovato.'); statusDiv.style.display = 'none'; } } catch (error) { alert('Errore di rete.'); statusDiv.style.display = 'none'; } }
        document.getElementById('search-box').addEventListener('keyup', e => { if (e.key === 'Enter') document.getElementById('search-button').click(); });
    </script>
</body>
</html>
