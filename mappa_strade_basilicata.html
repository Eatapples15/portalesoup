<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Mappa Stradale Ricercabile - Basilicata</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        html, body, #map { height: 100%; width: 100%; margin: 0; padding: 0; background-color: #f0f0f0; }
        .leaflet-control-layers-expanded { max-height: 80vh; overflow-y: auto; }
        .leaflet-popup-content a { color: #0078A8; text-decoration: none; font-weight: bold; }
        .leaflet-popup-content a:hover { text-decoration: underline; }
        #loading-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.75); z-index: 20000; display: flex; justify-content: center; align-items: center; color: white; }
        #loading-box { background-color: #333; padding: 25px; border-radius: 8px; font-family: sans-serif; font-size: 16px; text-align: center; }
        #search-container { position: absolute; top: 10px; left: 50px; z-index: 1000; background: white; padding: 10px; border-radius: 5px; box-shadow: 0 1px 5px rgba(0,0,0,0.65); }
        #search-container input { width: 200px; padding: 5px; border: 1px solid #ccc; }
        #search-container button { padding: 5px 10px; }
        #search-result { margin-top: 10px; font-size: 14px; }
    </style>
</head>
<body>

    <div id="map"></div>

    <div id="search-container">
        <input type="text" id="search-input" placeholder="Es. SS407 112">
        <button onclick="searchKm()">Cerca</button>
        <div id="search-result"></div>
    </div>

    <div id="loading-overlay">
        <div id="loading-box">
            <p><strong>Calcolo percorsi e indicizzazione chilometri...</strong></p>
            <p id="loading-status">Questo processo richiede fino a un minuto.</p>
        </div>
    </div>

<script>
    // --- DATABASE STRADE (versione estesa) ---
    const roads = [
        { label: "SS7 - Via Appia", start: { lat: 40.8452, lng: 15.3768 }, end: { lat: 40.6620, lng: 16.5991 }, color: '#d62728' },
        { label: "SS18 - Tirrena Inferiore", start: { lat: 40.0443, lng: 15.6467 }, end: { lat: 39.8780, lng: 15.7951 }, color: '#1f77b4' },
        { label: "SS19 - delle Calabrie", start: { lat: 40.3541, lng: 15.6315 }, end: { lat: 39.8822, lng: 15.8236 }, color: '#2ca02c' },
        { label: "SS92 - Appennino Meridionale", start: { lat: 40.6400, lng: 15.7950 }, end: { lat: 40.0195, lng: 16.4988 }, color: '#ff7f0e' },
        { label: "SS93 - Appulo Lucana", start: { lat: 40.6433, lng: 15.8075 }, end: { lat: 41.2825, lng: 16.0366 }, color: '#9467bd' },
        { label: "SS95 - di Brienza", start: { lat: 40.4591, lng: 15.5794 }, end: { lat: 40.3541, lng: 15.6315 }, color: '#8c564b' },
        { label: "SS104 - di Sapri", start: { lat: 40.0718, lng: 15.6316 }, end: { lat: 40.0984, lng: 16.6346 }, color: '#e377c2' },
        { label: "SS106 - Jonica", start: { lat: 40.3800, lng: 16.8220 }, end: { lat: 40.0883, lng: 16.6375 }, color: '#7f7f7f' },
        { label: "SS407 - Basentana", start: { lat: 40.6380, lng: 15.7554 }, end: { lat: 40.3800, lng: 16.8220 }, color: '#bcbd22' },
        { label: "SS585 - Fondo Valle del Noce", start: { lat: 40.0385, lng: 15.7891 }, end: { lat: 40.1170, lng: 15.8115 }, color: '#17becf' },
        { label: "SS598 - di Fondo Valle d'Agri", start: { lat: 40.3541, lng: 15.6315 }, end: { lat: 40.2458, lng: 16.5711 }, color: '#d62728' },
        { label: "SS653 - Valle del Sinni", start: { lat: 40.1170, lng: 15.8115 }, end: { lat: 40.1802, lng: 16.6196 }, color: '#2ca02c' },
        { label: "SS655 - Bradanica", start: { lat: 40.6720, lng: 16.5700 }, end: { lat: 41.3200, lng: 15.5350 }, color: '#ff7f0e' },
        { label: "SS658 - Potenza-Melfi", start: { lat: 40.6698, lng: 15.7951 }, end: { lat: 41.0183, lng: 15.6720 }, color: '#9467bd' },
        { label: "SP4 - del Pollino", start: { lat: 40.0872, lng: 15.9125 }, end: { lat: 39.9168, lng: 16.2081 }, color: '#1f77b4' },
        { label: "SP5 - della Sellata", start: { lat: 40.5979, lng: 15.7924 }, end: { lat: 40.5284, lng: 15.8890 }, color: '#aec7e8' },
        { label: "SP8 - del Vulture", start: { lat: 40.9491, lng: 15.7725 }, end: { lat: 40.8413, lng: 15.9922 }, color: '#ffbb78' },
        { label: "SP11 - Alto Agri", start: { lat: 40.3346, lng: 15.9452 }, end: { lat: 40.2920, lng: 15.7802 }, color: '#98df8a' },
        { label: "SP ex SS103 - Val d'Agri", start: { lat: 40.3541, lng: 15.6315 }, end: { lat: 40.2449, lng: 15.8034 }, color: '#ff9896' },
        { label: "SP3 - Matera-Metaponto", start: { lat: 40.6620, lng: 16.5991 }, end: { lat: 40.3800, lng: 16.8220 }, color: '#8c564b' },
        { label: "SP ex SS175", start: { lat: 40.6620, lng: 16.5991 }, end: { lat: 40.4000, lng: 16.7900 }, color: '#e377c2' },
        { label: "SP Pisticci-S.Basilio", start: { lat: 40.3888, lng: 16.5593 }, end: { lat: 40.4284, lng: 16.7118 }, color: '#bcbd22' },
        { label: "SP Tursi-Policoro", start: { lat: 40.2470, lng: 16.4710 }, end: { lat: 40.2100, lng: 16.6500 }, color: '#98df8a' }
    ];

    // --- MAPPA E VARIABILI GLOBALI ---
    const map = L.map('map').setView([40.5, 16.0], 9);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OpenStreetMap contributors' }).addTo(map);
    
    const layerControl = L.control.layers(null, null, { collapsed: false }).addTo(map);
    const roadDataForSearch = {}; // Oggetto per memorizzare i dati per la ricerca
    const allLayers = {}; // Oggetto per memorizzare i layer group

    // --- FUNZIONI CORE ---
    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const p1 = lat1 * Math.PI / 180, p2 = lat2 * Math.PI / 180;
        const delta = (lon2 - lon1) * Math.PI / 180;
        const d = Math.acos(Math.sin(p1) * Math.sin(p2) + Math.cos(p1) * Math.cos(p2) * Math.cos(delta)) * R;
        return isNaN(d) ? 0 : d;
    }

    function generateKilometerMarkers(polyline, road) {
        let totalDist = 0, lastMarkerDist = 0;
        const latlngs = polyline.getLatLngs();
        const roadMarkers = [];

        for (let i = 0; i < latlngs.length - 1; i++) {
            const start = latlngs[i], end = latlngs[i + 1];
            const segmentDist = getDistance(start.lat, start.lng, end.lat, end.lng);

            while (lastMarkerDist + 1000 <= totalDist + segmentDist) {
                const distToMarker = lastMarkerDist + 1000 - totalDist;
                const ratio = segmentDist > 0 ? distToMarker / segmentDist : 0;
                const markerLat = start.lat + (end.lat - start.lat) * ratio;
                const markerLng = start.lng + (end.lng - start.lng) * ratio;
                const km = Math.round((lastMarkerDist + 1000) / 1000);
                
                const streetViewUrl = `http://googleusercontent.com/maps.google.com/3{markerLat},${markerLng}`;
                const popupContent = `<b>${road.label} - Km ${km}</b><br>Lat: ${markerLat.toFixed(6)}<br>Lon: ${markerLng.toFixed(6)}<br><a href="${streetViewUrl}" target="_blank" rel="noopener noreferrer">Apri Street View</a>`;
                
                const marker = L.circleMarker([markerLat, markerLng], { radius: 4, color: '#000', weight: 1, fillColor: road.color, fillOpacity: 1.0 });
                marker.bindPopup(popupContent);
                
                // Salva i dati per la ricerca
                roadMarkers.push({ km: km, lat: markerLat, lng: markerLng, markerInstance: marker });
                lastMarkerDist += 1000;
            }
            totalDist += segmentDist;
        }
        return roadMarkers;
    }

    // --- FUNZIONI DI RICERCA ---
    async function reverseGeocode(lat, lng) {
        const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=10`;
        try {
            const response = await fetch(url);
            const data = await response.json();
            if (data.address) {
                return data.address.village || data.address.town || data.address.city || 'Non disponibile';
            }
            return 'Non disponibile';
        } catch (error) {
            console.error("Errore di geocodifica:", error);
            return "Errore";
        }
    }
    
    function searchKm() {
        const query = document.getElementById('search-input').value.trim();
        const resultDiv = document.getElementById('search-result');
        
        if (!query) {
            resultDiv.innerHTML = "Inserisci una strada e un km.";
            return;
        }

        const match = query.match(/^(.*?)\s*(\d+)$/);
        if (!match) {
            resultDiv.innerHTML = "Formato non valido. Usa 'Nome Strada KM', es. 'SS407 55'.";
            return;
        }
        
        const roadNameQuery = match[1].trim().toLowerCase().replace(/\s/g, '');
        const kmQuery = parseInt(match[2], 10);

        let bestMatch = null;
        for (const roadLabel in roadDataForSearch) {
            const normalizedLabel = roadLabel.toLowerCase().replace(/\s/g, '');
            if (normalizedLabel.includes(roadNameQuery)) {
                bestMatch = roadLabel;
                break;
            }
        }

        if (!bestMatch) {
            resultDiv.innerHTML = "Strada non trovata.";
            return;
        }

        const markerData = roadDataForSearch[bestMatch].find(m => m.km === kmQuery);

        if (!markerData) {
            resultDiv.innerHTML = `Chilometro ${kmQuery} non trovato per ${bestMatch}.`;
            return;
        }
        
        // Attiva il layer della strada se non è già visibile
        if (!map.hasLayer(allLayers[bestMatch])) {
            allLayers[bestMatch].addTo(map);
        }

        map.setView([markerData.lat, markerData.lng], 15);
        markerData.markerInstance.openPopup();
        
        resultDiv.innerHTML = `Posizione trovata! Sto cercando il comune...`;

        reverseGeocode(markerData.lat, markerData.lng).then(comune => {
            const gmapsUrl = `https://www.google.com/maps?q=${markerData.lat},${markerData.lng}`;
            resultDiv.innerHTML = `<b>Risultato:</b><br>` +
                                `Strada: ${bestMatch} - Km ${kmQuery}<br>` +
                                `Comune: ${comune}<br>` +
                                `<a href="${gmapsUrl}" target="_blank">Apri in Google Maps</a>`;
        });
    }

    // --- PROCESSO DI CARICAMENTO PRINCIPALE ---
    async function initializeMap() {
        const loadingStatus = document.getElementById('loading-status');
        const loadingOverlay = document.getElementById('loading-overlay');
        
        for (let i = 0; i < roads.length; i++) {
            const road = roads[i];
            loadingStatus.textContent = `Processando ${i + 1}/${roads.length}: ${road.label}`;
            const url = `https://router.project-osrm.org/route/v1/driving/${road.start.lng},${road.start.lat};${road.end.lng},${road.end.lat}?overview=full&geometries=geojson`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.code === 'Ok' && data.routes.length > 0) {
                    const routeCoords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
                    const polyline = L.polyline(routeCoords, { color: road.color, weight: 5, opacity: 0.85 });
                    
                    const roadLayerGroup = L.layerGroup();
                    polyline.addTo(roadLayerGroup);
                    
                    const markersData = generateKilometerMarkers(polyline, road);
                    markersData.forEach(m => m.markerInstance.addTo(roadLayerGroup));
                    
                    roadDataForSearch[road.label] = markersData;
                    allLayers[road.label] = roadLayerGroup;
                    layerControl.addOverlay(roadLayerGroup, road.label);
                }
            } catch (error) {
                console.error(`Errore nel caricamento di ${road.label}:`, error);
            }
        }
        loadingOverlay.style.display = 'none';
    }

    initializeMap();
</script>
</body>
</html>
