<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Mappa Stradale Completa Basilicata con Street View</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        html, body, #map { height: 100%; width: 100%; margin: 0; padding: 0; background-color: #f0f0f0; }
        .leaflet-popup-content { font-family: sans-serif; font-size: 13px; line-height: 1.5; }
        .leaflet-popup-content a { color: #0078A8; text-decoration: none; font-weight: bold; }
        .leaflet-popup-content a:hover { text-decoration: underline; }
        #loading-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
        }
        #loading-box {
            background-color: #333;
            padding: 25px;
            border-radius: 8px;
            font-family: sans-serif;
            font-size: 16px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

<div id="map"></div>
<div id="loading-overlay">
    <div id="loading-box">
        <p><strong>Caricamento Mappa Stradale Completa...</strong></p>
        <p id="loading-status">Inizializzazione...</p>
    </div>
</div>

<script>
    // --- DATABASE STRADE BASILICATA ---
    const roads = [
        // Strade Statali Principali
        { label: "SS7 - Via Appia", start: { lat: 40.8452, lng: 15.3768 }, end: { lat: 40.6620, lng: 16.5991 }, color: '#d62728' },
        { label: "SS18 - Tirrena Inferiore", start: { lat: 40.0443, lng: 15.6467 }, end: { lat: 39.8780, lng: 15.7951 }, color: '#1f77b4' },
        { label: "SS19 - delle Calabrie", start: { lat: 40.3541, lng: 15.6315 }, end: { lat: 39.8822, lng: 15.8236 }, color: '#2ca02c' },
        { label: "SS92 - Appennino Meridionale", start: { lat: 40.6400, lng: 15.7950 }, end: { lat: 40.0195, lng: 16.4988 }, color: '#ff7f0e' },
        { label: "SS93 - Appulo Lucana", start: { lat: 40.6433, lng: 15.8075 }, end: { lat: 41.2825, lng: 16.0366 }, color: '#9467bd' },
        { label: "SS95 - di Brienza", start: { lat: 40.4591, lng: 15.5794 }, end: { lat: 40.3541, lng: 15.6315 }, color: '#8c564b' },
        { label: "SS104 - di Sapri", start: { lat: 40.0718, lng: 15.6316 }, end: { lat: 40.0984, lng: 16.6346 }, color: '#e377c2' },
        { label: "SS106 - Jonica", start: { lat: 40.3800, lng: 16.8220 }, end: { lat: 40.0883, lng: 16.6375 }, color: '#7f7f7f' },
        { label: "SS407 - Basentana", start: { lat: 40.6380, lng: 15.7554 }, end: { lat: 40.3800, lng: 16.8220 }, color: '#bcbd22' },
        { label: "SS585 - Fondo Valle del Noce", start: { lat: 40.0385, lng: 15.7891 }, end: { lat: 40.1170, lng: 15.8115 }, color: '#17becf' },
        { label: "SS598 - di Fondo Valle d'Agri", start: { lat: 40.3541, lng: 15.6315 }, end: { lat: 40.2458, lng: 16.5711 }, color: '#d62728' },
        { label: "SS653 - Valle del Sinni", start: { lat: 40.1170, lng: 15.8115 }, end: { lat: 40.1802, lng: 16.6196 }, color: '#2ca02c' },
        { label: "SS655 - Bradanica", start: { lat: 40.6720, lng: 16.5700 }, end: { lat: 41.3200, lng: 15.5350 }, color: '#ff7f0e' },
        { label: "SS658 - Potenza-Melfi", start: { lat: 40.6698, lng: 15.7951 }, end: { lat: 41.0183, lng: 15.6720 }, color: '#9467bd' },

        // Provincia di Potenza (SP e ex-SS)
        { label: "SP4 - del Pollino", start: { lat: 40.0872, lng: 15.9125 }, end: { lat: 39.9168, lng: 16.2081 }, color: '#1f77b4' },
        { label: "SP5 - della Sellata", start: { lat: 40.5979, lng: 15.7924 }, end: { lat: 40.5284, lng: 15.8890 }, color: '#aec7e8' },
        { label: "SP8 - del Vulture", start: { lat: 40.9491, lng: 15.7725 }, end: { lat: 40.8413, lng: 15.9922 }, color: '#ffbb78' },
        { label: "SP11 - Alto Agri", start: { lat: 40.3346, lng: 15.9452 }, end: { lat: 40.2920, lng: 15.7802 }, color: '#98df8a' },
        { label: "SP16 - Marsicana", start: { lat: 40.4851, lng: 15.9554 }, end: { lat: 40.3346, lng: 15.9452 }, color: '#ff9896' },
        { label: "SP18 - Ofantina", start: { lat: 40.9200, lng: 15.4850 }, end: { lat: 40.9700, lng: 15.6300 }, color: '#c5b0d5' },
        { label: "SP19 - Moliternese", start: { lat: 40.2449, lng: 15.8034 }, end: { lat: 40.0984, lng: 16.0822 }, color: '#c49c94' },
        { label: "SP29 - Valsinni-Noepoli", start: { lat: 40.1652, lng: 16.3000 }, end: { lat: 40.1064, lng: 16.2995 }, color: '#f7b6d2' },
        { label: "SP32 - della Camastra", start: { lat: 40.5284, lng: 15.8890 }, end: { lat: 40.5303, lng: 16.0673 }, color: '#dbdb8d' },
        { label: "SP43 - Anello del Vulture", start: { lat: 40.9500, lng: 15.6300 }, end: { lat: 40.8900, lng: 15.6200 }, color: '#9edae5' },
        { label: "SP ex SS103 - Val d'Agri", start: { lat: 40.3541, lng: 15.6315 }, end: { lat: 40.2449, lng: 15.8034 }, color: '#ffbb78' },
        { label: "SP ex SS167 - Laghi di Monticchio", start: { lat: 40.9329, lng: 15.5800 }, end: { lat: 40.9500, lng: 15.6300 }, color: '#98df8a' },
        { label: "SP ex SS276 - Alto Agri", start: { lat: 40.3703, lng: 16.0964 }, end: { lat: 40.2920, lng: 15.7802 }, color: '#ff9896' },
        { label: "SP ex SS481 - Valle del Ferro", start: { lat: 40.0827, lng: 16.3242 }, end: { lat: 40.1400, lng: 16.4200 }, color: '#c5b0d5' },

        // Provincia di Matera (SP e ex-SS)
        { label: "SP3 - Matera-Metaponto", start: { lat: 40.6620, lng: 16.5991 }, end: { lat: 40.3800, lng: 16.8220 }, color: '#8c564b' },
        { label: "SP ex SS175", start: { lat: 40.6620, lng: 16.5991 }, end: { lat: 40.4000, lng: 16.7900 }, color: '#e377c2' },
        { label: "SP Matera-Grassano", start: { lat: 40.6329, lng: 16.5714 }, end: { lat: 40.6337, lng: 16.2843 }, color: '#7f7f7f' },
        { label: "SP Pisticci-S.Basilio", start: { lat: 40.3888, lng: 16.5593 }, end: { lat: 40.4284, lng: 16.7118 }, color: '#bcbd22' },
        { label: "SP Montescaglioso-Metaponto", start: { lat: 40.5480, lng: 16.6660 }, end: { lat: 40.4000, lng: 16.7900 }, color: '#17becf' },
        { label: "SP Irsina-Gravina", start: { lat: 40.7470, lng: 16.2410 }, end: { lat: 40.8190, lng: 16.4220 }, color: '#aec7e8' },
        { label: "SP Ferrandina-Matera", start: { lat: 40.5050, lng: 16.4670 }, end: { lat: 40.6620, lng: 16.5991 }, color: '#ffbb78' },
        { label: "SP Tursi-Policoro", start: { lat: 40.2470, lng: 16.4710 }, end: { lat: 40.2100, lng: 16.6500 }, color: '#98df8a' },
        { label: "SP Craco-Pisticci", start: { lat: 40.3750, lng: 16.4400 }, end: { lat: 40.3888, lng: 16.5593 }, color: '#ff9896' },
        { label: "SP Pomarico-Pisticci Scalo", start: { lat: 40.5100, lng: 16.5500 }, end: { lat: 40.4350, lng: 16.5800 }, color: '#c5b0d5' }
    ];

    // --- MAPPA E FUNZIONI ---
    const map = L.map('map').setView([40.5, 16.0], 9);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: 'Â© OpenStreetMap contributors' }).addTo(map);
    const layerControl = L.control.layers(null, null, { collapsed: false }).addTo(map);

    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const p1 = lat1 * Math.PI / 180, p2 = lat2 * Math.PI / 180;
        const delta = (lon2 - lon1) * Math.PI / 180;
        const d = Math.acos(Math.sin(p1) * Math.sin(p2) + Math.cos(p1) * Math.cos(p2) * Math.cos(delta)) * R;
        return isNaN(d) ? 0 : d;
    }

    function generateKilometerMarkers(polyline, layerGroup, roadLabel) {
        let totalDist = 0, lastMarkerDist = 0;
        const latlngs = polyline.getLatLngs();
        for (let i = 0; i < latlngs.length - 1; i++) {
            const start = latlngs[i], end = latlngs[i + 1];
            const segmentDist = getDistance(start.lat, start.lng, end.lat, end.lng);
            while (lastMarkerDist + 1000 <= totalDist + segmentDist) {
                const distToMarker = lastMarkerDist + 1000 - totalDist;
                const ratio = segmentDist > 0 ? distToMarker / segmentDist : 0;
                const markerLat = start.lat + (end.lat - start.lat) * ratio;
                const markerLng = start.lng + (end.lng - start.lng) * ratio;
                const km = Math.round((lastMarkerDist + 1000) / 1000);
                
                const streetViewUrl = `https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${markerLat},${markerLng}`;
                const popupContent = `<b>${roadLabel} - Km ${km}</b><br>` +
                                     `Lat: ${markerLat.toFixed(6)}<br>` +
                                     `Lon: ${markerLng.toFixed(6)}<br>` +
                                     `<a href="${streetViewUrl}" target="_blank" rel="noopener noreferrer">Apri Street View</a>`;

                const marker = L.circleMarker([markerLat, markerLng], { radius: 4, color: '#000', weight: 1, fillColor: road.color, fillOpacity: 1.0 });
                marker.bindPopup(popupContent);
                marker.addTo(layerGroup);
                lastMarkerDist += 1000;
            }
            totalDist += segmentDist;
        }
    }

    async function fetchAndDrawRoute(road, retries = 3, delay = 1000) {
        const url = `https://router.project-osrm.org/route/v1/driving/${road.start.lng},${road.start.lat};${road.end.lng},${road.end.lat}?overview=full&geometries=geojson`;
        try {
            const response = await fetch(url);
            if (!response.ok) {
                if (response.status === 429 && retries > 0) { // Too Many Requests
                    await new Promise(res => setTimeout(res, delay));
                    return fetchAndDrawRoute(road, retries - 1, delay * 2);
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            if (data.code !== 'Ok' || data.routes.length === 0) return;
            
            const routeCoords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
            const polyline = L.polyline(routeCoords, { color: road.color, weight: 5, opacity: 0.85 });
            const roadLayerGroup = L.layerGroup();
            
            polyline.addTo(roadLayerGroup);
            generateKilometerMarkers(polyline, roadLayerGroup, road.label);
            layerControl.addOverlay(roadLayerGroup, road.label);
        } catch (error) {
            console.error(`Errore nel caricamento di ${road.label}:`, error);
        }
    }

    async function processAllRoads() {
        const loadingStatus = document.getElementById('loading-status');
        const loadingOverlay = document.getElementById('loading-overlay');
        
        const allPromises = [];
        for (let i = 0; i < roads.length; i++) {
            const road = roads[i];
            const promise = fetchAndDrawRoute(road).then(() => {
                loadingStatus.textContent = `Caricato: ${i + 1} / ${roads.length} (${road.label})`;
            });
            allPromises.push(promise);
        }
        
        await Promise.all(allPromises);
        
        loadingOverlay.style.display = 'none';
    }

    // Aggiungi un sottoinsieme di strade per default per non sovraccaricare la vista iniziale
    const defaultVisibleLayers = ["SS407 - Basentana", "SS106 - Jonica", "SS658 - Potenza-Melfi"];
    
    // Processa tutte le strade e poi aggiungi i layer alla mappa
    async function initMap() {
        const loadingStatus = document.getElementById('loading-status');
        const loadingOverlay = document.getElementById('loading-overlay');
        const allLayers = {};

        for (let i = 0; i < roads.length; i++) {
            const road = roads[i];
            loadingStatus.textContent = `Preparazione tracciato ${i + 1} di ${roads.length}: ${road.label}...`;
            const url = `https://router.project-osrm.org/route/v1/driving/${road.start.lng},${road.start.lat};${road.end.lng},${road.end.lat}?overview=full&geometries=geojson`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.code === 'Ok' && data.routes.length > 0) {
                    const routeCoords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
                    const polyline = L.polyline(routeCoords, { color: road.color, weight: 5, opacity: 0.85 });
                    const roadLayerGroup = L.layerGroup();
                    polyline.addTo(roadLayerGroup);
                    generateKilometerMarkers(polyline, roadLayerGroup, road.label);
                    allLayers[road.label] = roadLayerGroup;
                }
            } catch (error) {
                console.error(`Errore nel caricamento di ${road.label}:`, error);
            }
        }
        
        // Aggiungi i layer al controllo e alla mappa
        for (const label in allLayers) {
            layerControl.addOverlay(allLayers[label], label);
            if (defaultVisibleLayers.includes(label)) {
                allLayers[label].addTo(map);
            }
        }

        loadingOverlay.style.display = 'none';
    }

    initMap();

</script>
</body>
</html>
