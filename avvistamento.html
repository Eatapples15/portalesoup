<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mappa Pattugliamento Avvistamento</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    
    <style>
        html, body, #map {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        #panel {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            width: 300px;
            max-height: 90%;
            overflow-y: auto;
        }
        #panel h3 {
            margin-top: 0;
        }
        #odv-list .odv-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #odv-list .odv-item:hover {
            background-color: #f0f0f0;
        }
        #odv-list .odv-item.selected {
            background-color: #cfe2ff;
            font-weight: bold;
        }
        .assigned-label {
            font-size: 0.8em;
            color: #28a745;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div id="map"></div>
    <div id="panel">
        <h3>ODV di Avvistamento</h3>
        <div id="status"><p>Caricamento dati...</p></div>
        <div id="odv-list"></div>
    </div>

    <script>
        // --- CONFIGURAZIONE ---
        const SHEET_ID = '1mNeb2ObFeD72o-WfNEzM4f2JfWl9iguqN4KGytpFS_Y';
        const SHEET_NAME = 'Foglio1'; 
        const COLUMN_NAMES = { 
            name: 'associazione', 
            sighting: 'avvistamento', 
            lat: 'lat', 
            lon: 'lon' 
        };

        // --- INIZIALIZZAZIONE MAPPA ---
        const map = L.map('map').setView([40.5, 15.8], 9);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors' 
        }).addTo(map);

        // --- STATO DELL'APPLICAZIONE ---
        const sightingODVs = [];
        let selectedODV = null;

        // --- SETUP LIVELLI E DISEGNO ---
        const drawnItems = new L.FeatureGroup().addTo(map);
        const drawControl = new L.Control.Draw({
            draw: {
                polygon: true,
                polyline: false,
                rectangle: true,
                circle: false,
                marker: false,
                circlemarker: false
            },
            edit: {
                featureGroup: drawnItems
            }
        });
        map.addControl(drawControl);

        // --- FUNZIONI PRINCIPALI ---

        function updateODVList() {
            const listDiv = document.getElementById('odv-list');
            listDiv.innerHTML = '';
            sightingODVs.forEach(org => {
                const item = document.createElement('div');
                item.className = 'odv-item';
                item.id = `odv-${org.id}`;
                item.innerText = org.name;
                
                if (org.patrolArea) {
                    const assignedLabel = document.createElement('span');
                    assignedLabel.className = 'assigned-label';
                    assignedLabel.innerText = ' - Area Assegnata';
                    item.appendChild(assignedLabel);
                }

                if (selectedODV && selectedODV.id === org.id) {
                    item.classList.add('selected');
                }
                
                item.onclick = () => selectODV(org);
                listDiv.appendChild(item);
            });
        }

        function selectODV(org) {
            selectedODV = org;
            updateODVList(); // Aggiorna la UI per mostrare la selezione
        }

        // --- GESTIONE EVENTI DI DISEGNO ---
        map.on(L.Draw.Event.CREATED, function (event) {
            const layer = event.layer;

            if (!selectedODV) {
                alert("Per favore, seleziona prima una squadra a cui assegnare questa zona.");
                return;
            }

            // Rimuovi la vecchia area se ne esisteva una
            if (selectedODV.patrolArea) {
                drawnItems.removeLayer(selectedODV.patrolArea);
            }

            // Assegna la nuova area
            selectedODV.patrolArea = layer;
            
            layer.bindPopup(`<b>Area di pattuglia per:</b><br>${selectedODV.name}`);
            layer.setStyle({ color: '#28a745', weight: 2 });
            drawnItems.addLayer(layer);
            
            // Resetta la selezione e aggiorna la lista
            selectedODV = null;
            updateODVList();
        });

        // --- CARICAMENTO DATI DAL FOGLIO GOOGLE ---
        const sheetUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}`;

        fetch(sheetUrl)
            .then(response => response.text())
            .then(text => {
                const json = JSON.parse(text.substring(47).slice(0, -2));
                const headers = json.table.cols.map(col => col.label.toLowerCase().trim());
                const rows = json.table.rows;
                
                const idx = {
                    name: headers.indexOf(COLUMN_NAMES.name),
                    sighting: headers.indexOf(COLUMN_NAMES.sighting),
                    lat: headers.indexOf(COLUMN_NAMES.lat),
                    lon: headers.indexOf(COLUMN_NAMES.lon)
                };

                rows.forEach((row, i) => {
                    const lat = row.c[idx.lat] ? row.c[idx.lat].v : null;
                    const lon = row.c[idx.lon] ? row.c[idx.lon].v : null;
                    const sightingValue = (idx.sighting > -1 && row.c[idx.sighting]) ? row.c[idx.sighting].v : '';

                    // Filtra solo le ODV di avvistamento
                    if (typeof lat === 'number' && typeof lon === 'number' && sightingValue && sightingValue.toLowerCase() === 'si') {
                        const orgName = (idx.name > -1 && row.c[idx.name]) ? row.c[idx.name].v : 'N/D';
                        const org = {
                            id: i,
                            name: orgName,
                            latlng: L.latLng(lat, lon),
                            patrolArea: null
                        };
                        
                        const sightingIcon = L.icon({
                            iconUrl: 'https://img.icons8.com/plasticine/100/binoculars.png',
                            iconSize: [38, 38],
                            iconAnchor: [19, 38],
                            popupAnchor: [0, -38]
                        });
                        
                        org.marker = L.marker(org.latlng, { icon: sightingIcon })
                            .addTo(map)
                            .bindPopup(`<b>${org.name}</b><br>Squadra di avvistamento`)
                            .on('click', () => selectODV(org));
                        
                        sightingODVs.push(org);
                    }
                });
                
                document.getElementById('status').style.display = 'none';
                updateODVList();
                
            }).catch(error => {
                console.error('Errore nel caricamento dei dati:', error);
                document.getElementById('status').innerHTML = `<p style="color:red;">Errore caricamento dati. Controlla la console.</p>`;
            });

    </script>
</body>
</html>
